<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Labels removed</title>
		<script type="text/javascript" src="d3/d3.v3.js"></script>
		<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
		<style type="text/css">
			
			.axis path,
			.axis line {
				fill: none;
				stroke: black;
				shape-rendering: crispEdges;
			}
			
			.axis text {
				font-family: sans-serif;
				font-size: 11px;
			}

		</style>
	</head>
	<body>
		<div id='map'>
		</div>
		<div id='headline'>
			My headline
		</div>
		<div id='standfirst'>
			My standfirst
		</div>

		<script type="text/javascript">

			var window_height = $(window).height()

			var limit_text = function(string) {
				if (string.length >= 10) {
					return string.substring(0,9)+"...";
				}
				else {
					return string
				}
			}

			var smallest_element_in_list = function(list) {
				var best_len = 1000;
				for (var i = 0; i<list.length; i++) {
					//console.log("i is now",i)
					//console.log("current length is ", best_len)
					//console.log("word to test is", list[i])
					if (list[i].length < best_len) {
						output = list[i];
						best_len = list[i].length
						//console.log("This beat it!")
						//console.log("Best length is now", best_len)
					}
				}
				return output;
			}

			var first_short_element = function(list, N) {
				for (var i=0 ; i<list.length; i++) {
					if (list[i].length <= N) {
						return list[i]
					}
				}
				// if there are none under N, return shortest
				return smallest_element_in_list(list)
			}

			var randomize_color = function(string_colour) {
				var r1 = Math.round(Math.random()*10)
				var r2 = Math.round(Math.random()*10)
				var r3 = Math.round(Math.random()*10)
				return '#'+string_colour[1]+r1+string_colour[3]+r2+string_colour[5]+r3
			}

			function randomIntFromInterval(min,max)
				{
				    return Math.floor(Math.random()*(max-min+1)+min);
				}

			d3.json("grid.json", function(json) {
				dataset = json; 
			
				idealSize = window_height*0.9
				padding = 2

				var maxX = d3.max(dataset, function(d) { return d['x']; });
				var maxY = d3.max(dataset, function(d) { return d['y']; });
				var maxFB = d3.max(dataset, function(d) { return d['fb']; })
				var minRed = d3.min(dataset, function(d) { return d['r']; })
				var maxRed = d3.max(dataset, function(d) { return d['r']; })
				var minBlue = d3.min(dataset, function(d) { return d['b']; })
				var maxBlue = d3.max(dataset, function(d) { return d['b']; })
				var maxCluster = d3.max(dataset, function(d) { return d['cluster']; })

				// Setting the padding Bostock way
				var margin = {top: 10, right: 10, bottom: 10, left: 10};
				var width = idealSize*maxX/maxY - margin.left - margin.right, height = idealSize - margin.top - margin.bottom;
	    		var svg = d3.select("#map")
	    					.append("svg")
				   			.attr("width", width + margin.left + margin.right)
				   			.attr("height", height + margin.top + margin.bottom)
				  			.append("g")
				    		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


				//Create scale functions
				var xScale = d3.scale.linear()
									 .domain([0, maxX+1])
									 .range([0, width]);

				var yScale = d3.scale.linear()
									 .domain([0, maxY+1])
									 .range([0, height]);

				var sizeScale = d3.scale.linear()
									 .domain([0, maxFB])
									 .range([0, width/maxY]);

				var redScale = d3.scale.linear()
									 .domain([minRed, maxRed])
									 .range([80, 220]);

				var blueScale = d3.scale.linear()
									 .domain([minBlue, maxBlue])
									 .range([80, 220]);
				
				var labelScale = d3.scale.linear()
									 .domain([8, 20])
									 .range([16, 7]);

				var hslScale = d3.scale.linear()
									 .domain([0, maxCluster])
									 .range([0,40]);

				var fbScale = d3.scale.linear()
									 .domain([0, maxFB])
									 .range([0.5,0.8]);

				var colours = [ 'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)', 
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)',
								'hsl(50, 80%, 20%, 0.5)'];

				var heatmapColour = d3.scale.linear()
				  .domain([0, maxCluster])
				  .range([0, colours.length-1]);



				// //Define X axis
				// var xAxis = d3.svg.axis()
				// 				  .scale(xScale)
				// 				  .orient("bottom")
				// 				  .ticks(5);

				// //Define Y axis
				// var yAxis = d3.svg.axis()
				// 				  .scale(yScale)
				// 				  .orient("left")
				// 				  .ticks(5);



				//Create circles
				type = 'rect'
				//type = 'image'
				svg.selectAll(type)
				   .data(dataset)
				   .enter()
				   .append(type)
				   //.attr("transform", "translate(250, 0) rotate(45)")  // If rotating to diamond formation
				   .attr( {
				   		x: function(d,i) {return xScale(d['x'])},
				   		y: function(d) {return yScale(d['y'])},
				   		width: width/(maxX+1)-padding,
				   		height: height/(maxY+1)-padding,
				   		// width: function(d) {return sizeScale(d['fb'])},
				   		// height: function(d) {return sizeScale(d['fb'])},
				   		// fill: function(d) {return "rgb("+Math.round(redScale(d['r']))+", "+d['g']+", "+Math.round((blueScale(d['b'])))+")"}
				   		fill: function(d) { 
				   			return d3.hsl ( hslScale(d['cluster'])+(Math.random()*40) ,
				   											(Math.random()/2.0)+0.5 ,
				   											randomIntFromInterval(4,8)/10 )
				   							}

				   		//'xlink:href': function(d) {return d['img']},  // Set 'rect' to 'image' if we want to show image
				   })
				   .on("mouseover", function(d) {
			   		d3.select(this)
			   			.attr("fill", "orange");
			   		d3.select('#headline')
			   			.text(function() {return d['headline']})
			   		d3.select('#standfirst')
			   			.text(function() {return d['standfirst']})
				   })
				   .on("mouseout", function(d) {
					   d3.select(this)
					   		.transition()
					   		.duration(350)
							.attr("fill", function(d) { 
								return d3.hsl ( hslScale(d['cluster'])+(Math.random()*40) ,
				   											(Math.random()/2.0)+0.5 ,
				   											randomIntFromInterval(4,8)/10 )
							})
				   });

				svg.selectAll("text")
				   .data(dataset)
				   .enter()
				   .append("text")
				   .text(function(d) {return first_short_element(d['tags'],7)
					})
				   .attr("x", function(d,i) {return xScale(d['x']+0.47)
				   })
				   .attr("y", function(d,i) {return yScale(d['y']+0.52)
				   })
				   .attr("font-family", "sans-serif")
				   .attr("font-size", labelScale(maxX))
				   .attr("fill", "black")
				   .attr("text-anchor", "middle")
				   //.attr("textLength", width/(maxX+5))

				   // 	"x", function(d) {
				   // 		return xScale(d['x']);
				   // })
				   // .attr("y", function(d) {
				   // 		return yScale(d['y']);
				   // })
				   // .attr("width", function(d) {
				   // 		return sizeScale(d['fb']);
				   // })
				   // .attr("height", function(d) {
				   // 		return sizeScale(d['fb']);
				   // })
				   // .attr("fill", function(d) {
				   // 		return "rgb("+d['r']+", "+d['g']+", "+d['b']+")"
				   // });

				
				// //Create labels
				// svg.selectAll("text")
				//    .data(dataset)
				//    .enter()
				//    .append("text")
				//    .text(function(d) {
				//    		return d[0] + "," + d[1];
				//    })
				//    .attr("x", function(d) {
				//    		return xScale(d[0]);
				//    })
				//    .attr("y", function(d) {
				//    		return yScale(d[1]);
				//    })
				//    .attr("font-family", "sans-serif")
				//    .attr("font-size", "11px")
				//    .attr("fill", "red");
			  	
				
				// //Create X axis
				// svg.append("g")
				// 	.attr("class", "axis")
				// 	.attr("transform", "translate(0," + (h - padding) + ")")
				// 	.call(xAxis);
				
				// //Create Y axis
				// svg.append("g")
				// 	.attr("class", "axis")
				// 	.attr("transform", "translate(" + padding + ",0)")
				// 	.call(yAxis);
			});

		</script>
	</body>
</html>

